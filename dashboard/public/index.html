<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>CYBER BOT Dashboard</title>
    <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0-alpha1/dist/css/bootstrap.min.css" rel="stylesheet">
    <link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/bootstrap-icons@1.10.3/font/bootstrap-icons.css">
    <style>
        body {
            background-color: #121212;
            color: #e0e0e0;
            font-family: 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif;
        }
        .navbar {
            background-color: #1e1e1e;
            border-bottom: 1px solid #333;
        }
        .card {
            background-color: #1e1e1e;
            border: 1px solid #333;
            margin-bottom: 20px;
            transition: transform 0.3s;
        }
        .card:hover {
            transform: translateY(-5px);
            box-shadow: 0 10px 20px rgba(0, 0, 0, 0.3);
        }
        .card-header {
            background-color: #252525;
            border-bottom: 1px solid #333;
        }
        .list-group-item {
            background-color: #1e1e1e;
            border-color: #333;
            color: #e0e0e0;
        }
        .badge {
            font-size: 0.8em;
        }
        .message-container {
            height: 400px;
            overflow-y: auto;
        }
        .message {
            padding: 10px;
            margin-bottom: 10px;
            border-radius: 5px;
            background-color: #252525;
        }
        .message-sender {
            font-weight: bold;
            color: #00bcd4;
        }
        .message-time {
            font-size: 0.8em;
            color: #888;
        }
        .message-content {
            margin-top: 5px;
        }
        .group-list {
            max-height: 600px;
            overflow-y: auto;
        }
        .refresh-btn {
            position: fixed;
            bottom: 20px;
            right: 20px;
            z-index: 1000;
        }
        #loading {
            position: fixed;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            background-color: rgba(0, 0, 0, 0.7);
            display: flex;
            justify-content: center;
            align-items: center;
            z-index: 9999;
        }
        .spinner-border {
            width: 3rem;
            height: 3rem;
        }
    </style>
</head>
<body>
    <div id="loading">
        <div class="spinner-border text-primary" role="status">
            <span class="visually-hidden">Loading...</span>
        </div>
    </div>

    <nav class="navbar navbar-expand-lg navbar-dark sticky-top">
        <div class="container-fluid">
            <a class="navbar-brand" href="#">
                <i class="bi bi-robot me-2"></i>CYBER BOT Dashboard
            </a>
            <button class="navbar-toggler" type="button" data-bs-toggle="collapse" data-bs-target="#navbarNav">
                <span class="navbar-toggler-icon"></span>
            </button>
            <div class="collapse navbar-collapse" id="navbarNav">
                <ul class="navbar-nav me-auto">
                    <li class="nav-item">
                        <a class="nav-link active" href="#" id="groups-tab">Groups</a>
                    </li>
                    <li class="nav-item">
                        <a class="nav-link" href="#" id="messages-tab">Live Messages</a>
                    </li>
                </ul>
                <span class="navbar-text" id="stats">
                    Loading stats...
                </span>
            </div>
        </div>
    </nav>

    <div class="container mt-4">
        <div id="groups-section">
            <div class="row mb-4">
                <div class="col">
                    <div class="input-group">
                        <span class="input-group-text bg-dark text-light border-secondary">
                            <i class="bi bi-search"></i>
                        </span>
                        <input type="text" class="form-control bg-dark text-light border-secondary" 
                            id="group-search" placeholder="Search groups...">
                    </div>
                </div>
            </div>

            <div class="row" id="groups-container">
                <!-- Groups will be loaded here -->
                <div class="col-12 text-center">
                    <p>Loading groups...</p>
                </div>
            </div>
        </div>

        <div id="messages-section" style="display: none;">
            <div class="card">
                <div class="card-header d-flex justify-content-between align-items-center">
                    <h5 class="mb-0">Live Messages</h5>
                    <button class="btn btn-sm btn-outline-primary" id="refresh-messages">
                        <i class="bi bi-arrow-clockwise"></i> Refresh
                    </button>
                </div>
                <div class="card-body message-container" id="messages-container">
                    <!-- Messages will be loaded here -->
                    <p class="text-center">Loading messages...</p>
                </div>
            </div>
        </div>

        <div id="group-details-section" style="display: none;">
            <button class="btn btn-sm btn-outline-secondary mb-3" id="back-to-groups">
                <i class="bi bi-arrow-left"></i> Back to Groups
            </button>
            
            <div class="card mb-4">
                <div class="card-header">
                    <h4 id="group-name">Group Name</h4>
                </div>
                <div class="card-body">
                    <div class="row">
                        <div class="col-md-6">
                            <p><strong>Group ID:</strong> <span id="group-id"></span></p>
                            <p><strong>Member Count:</strong> <span id="member-count"></span></p>
                            <p><strong>Group Type:</strong> <span id="group-type"></span></p>
                        </div>
                        <div class="col-md-6">
                            <p><strong>Settings:</strong></p>
                            <div id="group-settings">
                                <!-- Settings will be loaded here -->
                            </div>
                        </div>
                    </div>
                </div>
            </div>

            <div class="card">
                <div class="card-header">
                    <h5>Members</h5>
                </div>
                <div class="card-body">
                    <div class="input-group mb-3">
                        <span class="input-group-text bg-dark text-light border-secondary">
                            <i class="bi bi-search"></i>
                        </span>
                        <input type="text" class="form-control bg-dark text-light border-secondary" 
                            id="member-search" placeholder="Search members...">
                    </div>
                    <ul class="list-group" id="members-list">
                        <!-- Members will be loaded here -->
                    </ul>
                </div>
            </div>
        </div>
    </div>

    <button class="btn btn-primary rounded-circle refresh-btn" id="refresh-data">
        <i class="bi bi-arrow-clockwise"></i>
    </button>

    <script src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0-alpha1/dist/js/bootstrap.bundle.min.js"></script>
    <script>
        // DOM Elements
        const groupsTab = document.getElementById('groups-tab');
        const messagesTab = document.getElementById('messages-tab');
        const groupsSection = document.getElementById('groups-section');
        const messagesSection = document.getElementById('messages-section');
        const groupDetailsSection = document.getElementById('group-details-section');
        const groupsContainer = document.getElementById('groups-container');
        const messagesContainer = document.getElementById('messages-container');
        const backToGroupsBtn = document.getElementById('back-to-groups');
        const refreshDataBtn = document.getElementById('refresh-data');
        const refreshMessagesBtn = document.getElementById('refresh-messages');
        const groupSearch = document.getElementById('group-search');
        const memberSearch = document.getElementById('member-search');
        const loading = document.getElementById('loading');
        const stats = document.getElementById('stats');

        // Global variables
        let groups = [];
        let messages = [];
        let currentGroupId = null;

        // Initialize
        document.addEventListener('DOMContentLoaded', () => {
            loadGroups();
            setInterval(updateStats, 30000); // Update stats every 30 seconds
        });

        // Event Listeners
        groupsTab.addEventListener('click', (e) => {
            e.preventDefault();
            showSection('groups');
        });

        messagesTab.addEventListener('click', (e) => {
            e.preventDefault();
            showSection('messages');
            loadMessages();
        });

        backToGroupsBtn.addEventListener('click', () => {
            showSection('groups');
        });

        refreshDataBtn.addEventListener('click', () => {
            if (groupDetailsSection.style.display !== 'none') {
                loadGroupDetails(currentGroupId);
            } else if (messagesSection.style.display !== 'none') {
                loadMessages();
            } else {
                loadGroups();
            }
        });

        refreshMessagesBtn.addEventListener('click', loadMessages);

        groupSearch.addEventListener('input', filterGroups);
        memberSearch.addEventListener('input', filterMembers);

        // Functions
        function showSection(section) {
            groupsSection.style.display = 'none';
            messagesSection.style.display = 'none';
            groupDetailsSection.style.display = 'none';
            groupsTab.classList.remove('active');
            messagesTab.classList.remove('active');

            switch (section) {
                case 'groups':
                    groupsSection.style.display = 'block';
                    groupsTab.classList.add('active');
                    break;
                case 'messages':
                    messagesSection.style.display = 'block';
                    messagesTab.classList.add('active');
                    break;
                case 'group-details':
                    groupDetailsSection.style.display = 'block';
                    groupsTab.classList.add('active');
                    break;
            }
        }

        async function loadGroups() {
            showLoading(true);
            try {
                const response = await fetch('/api/groups');
                const data = await response.json();
                
                if (data.success) {
                    groups = data.groups;
                    renderGroups(groups);
                    updateStats();
                } else {
                    showError('Failed to load groups: ' + data.error);
                }
            } catch (error) {
                showError('Error loading groups: ' + error.message);
            } finally {
                showLoading(false);
            }
        }

        function renderGroups(groupsToRender) {
            if (groupsToRender.length === 0) {
                groupsContainer.innerHTML = '<div class="col-12 text-center"><p>No groups found</p></div>';
                return;
            }

            groupsContainer.innerHTML = '';
            groupsToRender.forEach(group => {
                const col = document.createElement('div');
                col.className = 'col-md-6 col-lg-4 mb-4';
                
                col.innerHTML = `
                    <div class="card h-100">
                        <div class="card-header d-flex justify-content-between align-items-center">
                            <h5 class="mb-0">${escapeHtml(group.name || 'Unknown Group')}</h5>
                            <span class="badge bg-primary">${group.memberCount} members</span>
                        </div>
                        <div class="card-body">
                            <p class="card-text"><small class="text-muted">ID: ${group.id}</small></p>
                            <p class="card-text">${group.isGroup ? 'Group Chat' : 'Direct Message'}</p>
                        </div>
                        <div class="card-footer bg-transparent border-top-0 text-end">
                            <button class="btn btn-sm btn-outline-info view-group" data-id="${group.id}">
                                <i class="bi bi-eye"></i> View Details
                            </button>
                        </div>
                    </div>
                `;
                
                groupsContainer.appendChild(col);
            });

            // Add event listeners to view buttons
            document.querySelectorAll('.view-group').forEach(button => {
                button.addEventListener('click', () => {
                    const groupId = button.getAttribute('data-id');
                    loadGroupDetails(groupId);
                });
            });
        }

        async function loadGroupDetails(groupId) {
            showLoading(true);
            currentGroupId = groupId;
            
            try {
                const response = await fetch(`/api/groups/${groupId}`);
                const data = await response.json();
                
                if (data.success) {
                    const group = data.group;
                    
                    // Update group details
                    document.getElementById('group-name').textContent = group.name || 'Unknown Group';
                    document.getElementById('group-id').textContent = group.id;
                    document.getElementById('member-count').textContent = group.memberCount;
                    document.getElementById('group-type').textContent = group.isGroup ? 'Group Chat' : 'Direct Message';
                    
                    // Render settings
                    const settingsEl = document.getElementById('group-settings');
                    settingsEl.innerHTML = '';
                    
                    if (group.settings && Object.keys(group.settings).length > 0) {
                        const settingsList = document.createElement('ul');
                        settingsList.className = 'list-unstyled';
                        
                        for (const [key, value] of Object.entries(group.settings)) {
                            if (typeof value !== 'object') {
                                const item = document.createElement('li');
                                item.innerHTML = `<strong>${key}:</strong> ${value}`;
                                settingsList.appendChild(item);
                            }
                        }
                        
                        settingsEl.appendChild(settingsList);
                    } else {
                        settingsEl.innerHTML = '<p>No settings available</p>';
                    }
                    
                    // Render members
                    const membersList = document.getElementById('members-list');
                    membersList.innerHTML = '';
                    
                    if (group.members && group.members.length > 0) {
                        group.members.forEach(member => {
                            const isAdmin = group.adminIDs.some(admin => admin.id === member.id);
                            
                            const item = document.createElement('li');
                            item.className = 'list-group-item d-flex justify-content-between align-items-center';
                            item.innerHTML = `
                                <div>
                                    <span>${escapeHtml(member.name)}</span>
                                    <small class="text-muted d-block">ID: ${member.id}</small>
                                </div>
                                ${isAdmin ? '<span class="badge bg-warning">Admin</span>' : ''}
                            `;
                            
                            membersList.appendChild(item);
                        });
                    } else {
                        membersList.innerHTML = '<li class="list-group-item">No members found</li>';
                    }
                    
                    showSection('group-details');
                } else {
                    showError('Failed to load group details: ' + data.error);
                }
            } catch (error) {
                showError('Error loading group details: ' + error.message);
            } finally {
                showLoading(false);
            }
        }

        async function loadMessages() {
            try {
                const response = await fetch('/api/messages');
                const data = await response.json();
                
                if (data.success) {
                    messages = data.messages;
                    renderMessages(messages);
                } else {
                    messagesContainer.innerHTML = `<p class="text-center text-danger">Failed to load messages: ${data.error}</p>`;
                }
            } catch (error) {
                messagesContainer.innerHTML = `<p class="text-center text-danger">Error loading messages: ${error.message}</p>`;
            }
        }

        function renderMessages(messagesToRender) {
            if (messagesToRender.length === 0) {
                messagesContainer.innerHTML = '<p class="text-center">No messages yet</p>';
                return;
            }

            messagesContainer.innerHTML = '';
            messagesToRender.forEach(msg => {
                const messageEl = document.createElement('div');
                messageEl.className = 'message';
                messageEl.innerHTML = `
                    <div class="d-flex justify-content-between">
                        <div class="message-sender">${escapeHtml(msg.senderName)} (${msg.senderID})</div>
                        <div class="message-time">${new Date(msg.timestamp).toLocaleString()}</div>
                    </div>
                    <div class="message-group">${escapeHtml(msg.threadName)} (${msg.threadID})</div>
                    <div class="message-content">${escapeHtml(msg.body)}</div>
                `;
                
                messagesContainer.appendChild(messageEl);
            });
        }

        function filterGroups() {
            const searchTerm = groupSearch.value.toLowerCase();
            const filteredGroups = groups.filter(group => 
                (group.name && group.name.toLowerCase().includes(searchTerm)) || 
                group.id.includes(searchTerm)
            );
            renderGroups(filteredGroups);
        }

        function filterMembers() {
            const searchTerm = memberSearch.value.toLowerCase();
            const memberItems = document.querySelectorAll('#members-list li');
            
            memberItems.forEach(item => {
                const memberName = item.querySelector('span').textContent.toLowerCase();
                const memberId = item.querySelector('small').textContent.toLowerCase();
                
                if (memberName.includes(searchTerm) || memberId.includes(searchTerm)) {
                    item.style.display = '';
                } else {
                    item.style.display = 'none';
                }
            });
        }

        function updateStats() {
            const totalGroups = groups.length;
            const totalMembers = groups.reduce((sum, group) => sum + group.memberCount, 0);
            stats.textContent = `Total Groups: ${totalGroups} | Total Members: ${totalMembers}`;
        }

        function showLoading(show) {
            loading.style.display = show ? 'flex' : 'none';
        }

        function showError(message) {
            alert(message);
        }

        function escapeHtml(unsafe) {
            if (typeof unsafe !== 'string') return unsafe;
            return unsafe
                .replace(/&/g, "&amp;")
                .replace(/</g, "&lt;")
                .replace(/>/g, "&gt;")
                .replace(/"/g, "&quot;")
                .replace(/'/g, "&#039;");
        }
    </script>
</body>
</html>